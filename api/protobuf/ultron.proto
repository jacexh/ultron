syntax = "proto3";

package wosai.ultron;

option go_package = "github.com/wosai/ultron/v2/pkg/genproto";

import "statistics.proto";

service UltronService {
    rpc Subscribe(Session) returns (stream Event) {}
    rpc Submit(RequestSubmit) returns (ResponseSubmit) {}
}

message Session {
    string slave_id = 1;
    map<string, string> extras = 2;
}

enum EventType {
    PING = 0; // 心跳包
    CONNECTED = 1;  //已连接
    DISCONNECT = 2; // 要求slave断开连接
    PLAN_STARTED = 3; // 测试计划开始
    PLAN_FINISHED = 4; // 测试计划结束
    PLAN_INTERRUPTED = 5; // 测试计划中断执行
    NEXT_STAGE_STARTED = 6; // 开始执行计划中的下一阶段
    STATS_AGGREGATE = 7;  // 上报统计对象
}

message TimerDTO {
    string type = 1;
    bytes timer = 2;
}

message AttackStrategyDTO {
    string type = 1;
    bytes attack_strategy = 2;
}

message Event {
    EventType type = 1;
    oneof data {
        string plan_name = 2;
        AttackStrategyDTO attack_strategy = 3;
        TimerDTO timer = 4;
    };
}

message RequestSubmit {
    uint32 batch_id = 1;
    AttackStatisticsDTO stats =2;
}


message ResponseSubmit {
    enum Result {
        ACCEPTED = 0; // 上报对象已经接收
        BATCH_EXPIRED = 1; // 批次已经结束
        UNKNOWN_BATCH = 2; // 批次ID错误3; // 批次ID错误
        UNKNOWN_PLAN = 3; // 计划名称错误
    }
    string plan_name = 1;
    string batch_id = 2;
    Result result = 3;
}
